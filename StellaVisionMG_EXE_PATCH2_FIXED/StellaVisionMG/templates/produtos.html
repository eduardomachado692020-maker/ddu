{% extends "base.html" %}
{% block content %}
<h4 class="mb-3">Produtos</h4>

<form method="post" action="/produtos">
  <div class="row g-2">
    <div class="col-md-4"><label class="form-label">Nome</label><input name="nome" class="form-control" required></div>
    <div class="col-md-2"><label class="form-label">Categoria</label><input name="categoria" class="form-control"></div>
    <div class="col-md-2"><label class="form-label">Plataforma</label><input name="plataforma" class="form-control"></div>
    <div class="col-md-2"><label class="form-label">Modelo</label><input name="modelo" class="form-control"></div>
    <div class="col-md-2"><label class="form-label">Capacidade</label><input name="capacidade" class="form-control"></div>
    <div class="col-md-2"><label class="form-label">Cor</label><input name="cor" class="form-control"></div>
    <div class="col-md-2"><label class="form-label">Região</label><input name="regiao" class="form-control"></div>
    <div class="col-md-2"><label class="form-label">Condição</label>
      <select name="condicao" class="form-select">
        <option>NOVO</option><option>USADO</option>
      </select>
    </div>
    <div class="col-md-2"><label class="form-label">Preço de tabela (R$)</label><input type="number" step="0.01" name="preco_lista" class="form-control"></div>
    <div class="col-md-2"><label class="form-label">Custo base (R$)</label><input type="number" step="0.01" name="custo_base" class="form-control"></div>
    <div class="col-md-2"><label class="form-label">Estoque mínimo</label><input type="number" name="estoque_minimo" class="form-control" value="0"></div>
    <div class="col-md-2"><label class="form-label">Estoque atual</label><input type="number" name="estoque_atual" class="form-control" value="0"></div>
    <div class="col-md-2">
      <label class="form-label">Data do produto</label>
      <!-- permite informar a data de criação do produto manualmente (opcional) -->
      <input type="datetime-local" name="data_produto" class="form-control">
    </div>
  </div>
  <hr>
  <h6>Fornecedor (inline)</h6>
  <div class="row g-2">
    <div class="col-md-3"><input name="fornecedor_nome" class="form-control" placeholder="Nome (novo ou existente)"></div>
    <div class="col-md-2"><input name="fornecedor_cidade" class="form-control" placeholder="Cidade"></div>
    <div class="col-md-2"><input name="fornecedor_telefone" class="form-control" placeholder="Telefone"></div>
    <div class="col-md-3"><input name="fornecedor_email" class="form-control" placeholder="Email"></div>
    <div class="col-md-2"><input name="fornecedor_doc" class="form-control" placeholder="Documento"></div>
  </div>
  <hr>
  <div class="mb-2">
    <label class="form-label">SKU (gerado automaticamente, editável)</label>
    <input name="sku" class="form-control" placeholder="Será gerado..." value="{{ generated_sku or '' }}">
    <div class="form-text"><a class="btn btn-sm btn-outline-primary mt-2" href="/produtos/sku/regenerar">Regenerar SKU</a></div>
  </div>
  <button class="btn btn-primary">Salvar produto</button>
</form>

<hr>
<h6>Produtos cadastrados</h6>
<table class="table table-sm table-striped">
  <thead>
    <tr>
      <th>SKU</th>
      <th>Nome</th>
      <th>Categoria</th>
      <th>Estoque (SKU)</th>
      <th>Estoque (modelo)</th>
      <th>Min (modelo)</th>
      <th>Ações</th>
    </tr>
  </thead>
  <tbody>
    {% for p in produtos %}
      {# constrói chave de agregação plataforma|modelo para consultar mapa #}
      {# Chave de agregação baseada somente em ``modelo`` para o estoque mínimo #}
      {% set key = p.modelo or '' %}
      {% set ag = modelo_minmap.get(key) %}
      {% set ag_min = ag['min'] if ag else 0 %}
      {% set ag_sum = ag['sum'] if ag else 0 %}
      <tr class="{% if ag_sum < ag_min %}table-warning{% endif %}">
        <td>{{ p.sku }}</td>
        <td>{{ p.nome }}</td>
        <td>{{ p.categoria or 'Sem categoria' }}</td>
        <td>{{ p.estoque_atual }}</td>
        <td>{{ ag_sum }}</td>
        <td>{{ ag_min }}</td>
        <td>
          <a href="{{ url_for('produto_edit', prod_id=p.id) }}" class="btn btn-sm btn-outline-secondary">Editar</a>
          <form method="post" action="{{ url_for('produto_delete', prod_id=p.id) }}" style="display:inline-block" onsubmit="return confirm('Excluir este produto? Esta ação é irreversível.');">
            <button type="submit" class="btn btn-sm btn-outline-danger ms-1">Excluir</button>
          </form>
        </td>
      </tr>
    {% endfor %}
  </tbody>
</table>
{% endblock %}
